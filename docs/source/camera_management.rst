.. _cameras:

*****************************
Управление видеокамерами
*****************************

Для настройки видео-идентификации лиц добавьте камеры в FindFace Security, сгруппировав их c учетом расположения.

.. rubric:: В этой главе:

.. contents::
   :local:


Создание группы камер
============================

Для создания группы камер выполните следующие действия:

#. В веб-интерфейсе перейдите на вкладку :guilabel:`Группы камер`.

    |create_camera_group_ru|

     .. |create_camera_group_ru| image:: /_static/create_camera_group.png
        :scale: 60%

     .. |create_camera_group_en| image:: /_static/create_camera_group_en.png
        :scale: 60%

#. Нажмите на кнопку :guilabel:`Создать`.
#. Введите имя группы и при необходимости комментарий к ней.
#. Если события от камер, принадлежащих одной группе, требуется дедуплицировать, т. е. исключить одинаковые события, поставьте флажок :guilabel:`Дедуплицировать события` и задайте интервал дедупликации (интервал, с которым события проверяются на уникальность).
#. Поставьте флажок :guilabel:`Активная`.

     |camera_group_ru|

     .. |camera_group_ru| image:: /_static/camera_group.png
        :scale: 80%

     .. |camera_group_en| image:: /_static/camera_group_en.png
        :scale: 80%

#. Нажмите на кнопку :guilabel:`Сохранить`.


Добавление камеры в группу
====================================

Для добавления камеры в группу выполните следующие действия:

#. В веб-интерфейсе перейдите на вкладку :guilabel:`Камеры`.

     |create_camera_ru|

     .. |create_camera_ru| image:: /_static/create_camera.png
        :scale: 60%

     .. |create_camera_en| image:: /_static/create_camera_en.png
        :scale: 60%


#. Нажмите на кнопку :guilabel:`Добавить`.
#. Введите название камеры и добавьте ее в одну из групп. При необходимости введите комментарий к камере.

     |camera_ru|

     .. |camera_ru| image:: /_static/camera.png
        :scale: 80%

     .. |camera_en| image:: /_static/camera_en.png
        :scale: 80%


#. Задайте URL камеры или адрес видеофайла для обработки.
 
#. Поставьте флажок :guilabel:`Активная`.
#. Нажмите на кнопку :guilabel:`Параметры`, чтобы задать параметры обработки видеопотока:
  
   * ``min_score``: Минимальное качество изображения лица при выборе лучшего. Определяется эмпирически: отрицательные значения вблизи 0 = наиболее качественные прямые изображения лиц анфас, -1 = хорошее качество, -2 = удовлетворительное качество, отрицательные значения -5 и меньше = перевернутые лица и лица, повернутые под большими углами, распознавание может быть неэффективным.
   * ``min_d_score``: Максимальное отклонение лица от положения анфас при выборе лучшего. Определяется эмпирически: -3.5 = слишком большие углы поворота, распознавание лиц может быть неэффективным,  -2.5 = удовлетворительное отклонение, -0.05 = близко к положению анфас, 0 = анфас.
   * ``min_face_size``: Минимальный размер лица в пикселях при выборе лучшего. Чем меньше значение, тем дольше осуществляется обнаружение и отслеживание лиц. Оптимальное значение: 80-100-120. Если 0, фильтр выключен.
   * ``max_face_size``: Максимальный размер лица в пикселях при выборе лучшего. Если 0, фильтр выключен.
   * ``realtime``: Режим реального времени. Выбирать лучший кадр с лицом в каждом интервале времени ``realtime_dly``. Если ``realtime_post_perm: true``, отправка лучшего кадра происходит по завершению каждого интервала ``realtime_dly``; если ``false``, лучший кадр отправляется, только если его качество улучшилось по сравнению с предыдущим отправленным кадром.
   * ``realtime_post_perm``: Если ``true``, отправлять лучший кадр в каждом интервале времени ``realtime_dly`` в режиме реального времени. Если ``false``, отправлять лучший кадр, только если его качество улучшилось по сравнению с предыдущим отправленным кадром.
   * ``realtime_dly``: Временной интервал в миллисекундах, в течение которого в режиме реального времени выбирается лучший кадр с лицом.
   * ``overall``: Буферный режим. Отправлять для лица один кадр наилучшего качества.
   * ``ROT``: Детектирование и отслеживание лиц только внутри заданной прямоугольной области. Используйте данную опцию, чтобы уменьшить нагрузку на ``fkvideo_detector``.
   * ``ROI``: Отправка в компонент ``ffsecurity`` только тех лиц, которые были обнаружены внутри интересующей области.

     .. |roi_rot_ru| image:: /_static/roi_rot.png
        :scale: 70%

     .. |roi_rot_en| image:: /_static/roi_rot_en.png
        :scale: 70%

     .. tip::
        Для задания ROT/ROI удобно использовать визуальный мастер. Сначала создайте камеру без ROT/ROI, затем откройте ее для редактирования и нажмите на кнопку :guilabel:`Параметры`. Вы увидите визуальный мастер.

#. Нажмите на кнопку :guilabel:`Дополнительные параметры`, чтобы задать опциональные параметры обработки видеопотока:

   * ``ffmpeg_params``: Опции ffmpeg для видеопотока. Задаются массивом строк ключ-значение, например, ``["rtsp_transpotr=tcp", "ss=00:20:00"]``.
   * ``fd_frame_height``: Размер кадра для детектора лиц в пикселях. Отрицательные значения соответствуют исходному размеру. Оптимальные значения для уменьшения нагрузки: 640-720.
   * ``npersons``: Максимальное количество лиц, одновременно отслеживаемых детектором лиц. Влияет на производительность.
   * ``tracker_threads``: Количество тредов отслеживания для детектора лиц. Должно быть меньше или равно значению параметра npersons. Оптимально, когда они равны. Если количество тредов отслеживания меньше, чем максимальное количество отслеживаемых лиц, потребление ресурсов уменьшается, однако также уменьшается и скорость отслеживания.
   * ``jpeg_quality``: Качество сжатия полного кадра для отправки.
   * ``draw_track``: Рисовать в bbox след от движения лица.
   * ``api_timeout``: Время ожидания в миллисекундах ответа на API-запрос.
   * ``md_threshold``: Минимальная интенсивность движения, которая будет регистрироваться детектором движения. Определяется эмпирически: 0 = детектор выключен, 0.002 = значение по умолчанию, 0.05 = минимальная интенсивность слишком высока, чтобы зарегистрировать движение.
   * ``md_scale``: Размер кадра для детектора движения относительно исходного размера от 0 до 1. Кадр должен быть уменьшен при больших разрешениях камеры, отображении лиц крупным планом, а также при чрезмерной загрузке процессора — для снижения потребления системных ресурсов.
 
#. Нажмите на кнопку :guilabel:`Сохранить`.

Мониторинг работы камер
==============================

Мониторинг работы камер выполняется на вкладке :guilabel:`Камеры`. 

     |monitor_cameras_ru|

     .. |monitor_cameras_ru| image:: /_static/monitor_cameras.png
        :scale: 70%

     .. |monitor_cameras_en| image:: /_static/monitor_cameras_en.png
        :scale: 70%


Статусы камер:

* Зеленый: идет обработка видеопотока с камеры, проблем не обнаружено.
* Желтый: камера работает менее 30 секунд или имеют место ошибки при отправке лиц.
* Красный: камера не работает.

Для каждой камеры приводятся следующие статистические данные по обработке видеопотока: длительность обработки/количество успешно отправленных лиц/количество лиц, обработанных с ошибками.

Для перезапуска камеры нажмите на кнопку :guilabel:`Перезапустить` в столбце :guilabel:`Статус`.

При большом количестве камер в системе используйте следующие фильтры:

* :guilabel:`Группа камер`,
* :guilabel:`Активная`,
* :guilabel:`Статус`.
